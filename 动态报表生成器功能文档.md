# 动态Excel报表生成器功能文档

## 📋 项目概述

动态Excel报表生成器是一个基于Java的报表生成系统，专门用于生成具有层次结构的权益日报。该系统支持模板解析、动态数据生成、层次结构排序等功能，能够根据实体对象自动生成符合业务需求的CSV格式报表。

## 🎯 核心功能

### 1. 模板解析功能
- **语法支持**：支持 `${对象.属性}` 语法进行数据注入
- **复杂表达式**：支持数学运算、~~~条件判断~~~等复杂表达式
- **时间序列**：支持 `${T-13}${CalculateUnitDo.avgSize}` 等时间序列表达式
- **特殊值处理**：支持 `#VALUE!` 等Excel特殊值

### 2. 层次结构数据生成
- **占位行**：自动生成只有产品名的占位行
- **产品数据**：根据实体对象生成产品数据行
- **小计行**：自动生成小计行，与相关产品相邻
- **合计行**：自动生成合计行，包含所有子项和小计

### 3. 动态排序功能
- **代码排序**：基于 `CalculateUnitDo.nodeCode` 进行字母顺序排序
- **逻辑分组**：小计项与相关产品按逻辑顺序排列
- **层级关系**：保持占位行 → 产品和小计 → 合计行的层级结构

## 🏗️ 系统架构

### 核心类说明

#### 1. SimplifiedHierarchicalCsvGenerator
**主要功能**：简化的层次结构CSV生成器
- 生成基于29列模板的CSV报表
- 实现动态排序和逻辑分组
- 支持占位行、产品、小计、合计的层次结构

#### 2. EnhancedTemplateParser
**主要功能**：增强的模板解析器
- 解析 `${对象.属性}` 语法
- 处理复杂表达式和数学运算
- 支持时间序列表达式

#### 3. 实体对象模型
- **CalculateUnitDo**：计算单元数据模型
- **AssetDo**：资产数据模型（已简化）
- **DwMarketBenchDo**：市场基准数据模型
- **DwSecurityMarketDo**：证券市场数据模型

## 📊 数据结构

### 层次结构说明

```
权益合计
├── 核心配置仓权益
│   ├── 港股通_OCI长期股投
│   ├── 人民币_产险OCI
│   ├── 平安资管_OCI高股息-小计
│   ├── 天虹高端制造混合(QDII)A
│   ├── 长城全球新能源车股票发起式(QDII)A
│   ├── 长城全球新能源汽车（QDII-LOF）
│   ├── 富兰克林国海全球科技互联
│   ├── 平安资管_QDII海外基金-小计
│   ├── ABC TEMPI
│   ├── SCHRODER ISF2
│   ├── FTSE JAPAN ETF AT UNITED1
│   ├── US EF RA ETF-USD INC AT UNITED
│   ├── WELLINGTONG GLOBAL RESEARCH
│   ├── 香港资管_QDII海外基金-小计
│   └── 核心配置仓权益-合计
├── 相对ALPHA仓权益
│   ├── 景顺长城新兴产业混合C
│   ├── 东方红中证优势成长指数发起C
│   ├── 中欧价值汇报混合C
│   ├── 华泰保兴
│   ├── 产险_直投FOF_红利+800-小计
│   ├── PL长期投资
│   ├── 产险_PL长期投资_800-小计
│   ├── 平安港股通红利精选
│   ├── 太平洋卓越灵活配置FOF
│   ├── 华宝港股通恒生中国
│   ├── 股指期货300_多
│   ├── 股指期货300_空_已实现
│   ├── 华夏国正消费电子主题ETF
│   ├── 平安资管_成长ETF_800-小计
│   ├── 华宝标普港股通低波ETF
│   ├── 红利低波
│   ├── 央企ETF
│   ├── 平安资管_价值ETF_红利-小计
│   └── 相对ALPHA仓权益-合计
└── 敏捷择时仓权益
    ├── 平安港股通红利精选
    ├── 产品_直投FOF_红利-小计
    ├── 太平洋卓越灵活配置FOF
    ├── 华宝港股通恒生中国
    ├── 产险_直投FOF_800-小计
    ├── 股指期货300_多
    ├── 股指期货300_空_已实现
    ├── 华夏国正消费电子主题ETF
    ├── 平安资管_成长ETF_800-小计
    ├── 华宝标普港股通低波ETF
    ├── 红利低波
    ├── 央企ETF
    ├── 平安资管_价值ETF_红利-小计
    └── 敏捷择时仓权益-合计
```

## 🔧 使用方法

### 1. 基本使用

```java
// 创建生成器实例
SimplifiedHierarchicalCsvGenerator generator = new SimplifiedHierarchicalCsvGenerator();

// 生成CSV报表
generator.generateCsvFile();
```

### 2. 自定义数据生成

```java
// 在 generateBaseData 方法中添加新的产品
addProduct(calculateUnits, "CUSTOM_PRODUCT_1", "CORE_EQUITY", "自定义产品名称");
addSubtotal(calculateUnits, "CUSTOM_SUBTOTAL_1", "CORE_EQUITY", "自定义小计名称");
```

### 3. 修改分组规则

```java
// 在 mergeProductsAndSubtotalsByGroup 方法中修改分组规则
subtotalGroups.put("CUSTOM_SUBTOTAL_1", Arrays.asList("CUSTOM_PRODUCT_1", "CUSTOM_PRODUCT_2"));
```

## 📈 输出格式

### CSV文件结构

| 列名 | 说明 | 示例 |
|------|------|------|
| 产品 | 产品名称 | 港股通_OCI长期股投 |
| 代码 | 产品代码 | CORE_PRODUCT_1 |
| 年初 | 年初规模 | 217.73 |
| 期末 | 期末规模 | 227.04 |
| 收益率 | 收益率 | 0.0796 |
| 基准收益率 | 基准收益率 | 0.035 |
| 超额收益率 | 超额收益率 | #VALUE! |
| ... | ... | ... |

### 特殊行说明

1. **占位行**：只有产品名，其他列为空
   ```
   核心配置仓权益,,,,,,,,,,,,,,,,,,,,,,,,,,,,
   ```

2. **小计行**：包含汇总数据，紧跟在相关产品之后
   ```
   平安资管_OCI高股息-小计,CORE_SUBTOTAL_1,2870.67,2543.19,0.0505,...
   ```

3. **合计行**：包含该组所有数据的汇总
   ```
   核心配置仓权益-合计,CORE_EQUITY_TOTAL,2021.14,2825.74,0.0405,...
   ```

## ⚙️ 配置说明

### 1. 模板配置
- 模板文件：`权益日报-20250925模板.csv`
- 列数：29列
- 支持表达式：`${CalculateUnitDo.属性名}`

### 2. 数据生成配置
- 产品数据：随机生成100-300范围的数值
- 汇总数据：随机生成1000-3000范围的数值
- 收益率：随机生成0.03-0.13范围的数值

### 3. 排序配置
- 父节点顺序：`CORE_EQUITY` → `ALPHA_EQUITY` → `AGILE_EQUITY` → `ROOT`
- 子项排序：按 `nodeCode` 字母顺序排序
- 小计位置：紧跟在相关产品之后

## 🚀 扩展功能

### 1. 添加新的产品组
```java
// 在 generateBaseData 方法中添加
addProduct(calculateUnits, "NEW_PRODUCT_1", "NEW_GROUP", "新产品名称");
addSubtotal(calculateUnits, "NEW_SUBTOTAL_1", "NEW_GROUP", "新小计名称");

// 在 sortHierarchicalData 方法中添加父节点顺序
List<String> parentOrder = Arrays.asList("CORE_EQUITY", "ALPHA_EQUITY", "AGILE_EQUITY", "NEW_GROUP", "ROOT");
```

### 2. 修改数据生成逻辑
```java
// 在 createCalculateUnit 方法中修改数据生成规则
if (isSummary) {
    // 修改汇总数据的生成范围
    unit.setBeginAssetSize(new BigDecimal(2000 + random.nextDouble() * 3000));
} else {
    // 修改产品数据的生成范围
    unit.setBeginAssetSize(new BigDecimal(200 + random.nextDouble() * 400));
}
```

### 3. 自定义模板解析
```java
// 在 EnhancedTemplateParser 中添加新的表达式支持
// 例如：支持日期格式化、货币格式化等
```

## 📝 注意事项

1. **数据一致性**：确保实体对象的属性与模板中的表达式匹配
2. **排序稳定性**：修改分组规则时，确保小计项与相关产品的对应关系正确
3. **性能考虑**：大量数据时，考虑使用流式处理或分批生成
4. **错误处理**：建议添加异常处理机制，确保生成过程的稳定性

## 🔍 故障排除

### 常见问题

1. **小计项位置错误**
   - 检查 `sortChildrenByCode` 方法中的分类逻辑
   - 确保小计项被分到 `subtotals` 列表而不是 `totals` 列表

2. **数据不显示**
   - 检查实体对象的属性是否与模板表达式匹配
   - 确认 `createCalculateUnit` 方法中的数据生成逻辑

3. **排序不正确**
   - 检查 `mergeProductsAndSubtotalsByGroup` 方法中的分组规则
   - 确认 `subtotalOrder` 列表的顺序

## 📞 技术支持

如有问题或需要技术支持，请检查：
1. Java版本兼容性（建议使用JDK 8+）
2. 依赖库版本（Apache POI、Lombok等）
3. 模板文件格式和内容
4. 实体对象的数据结构

---

**版本**：1.0.0  
**最后更新**：2025年1月  
**维护者**：开发团队
